<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>Ubuntu 20.04 on MacBook Pro 2011</title>

  <meta name="author" content="Sarang Baheti" />
  
  
  <meta name="description" content="setting up a functional ubuntu 20.04 on MacBook Pro 2011">
  

  <meta name="generator" content="Hugo 0.30.2" />

  <link rel="alternate" href="https://www.variadic.xyz/index.xml" type="application/rss+xml" title="a few notes">

  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" />
  <link rel="stylesheet" href="https://www.variadic.xyz/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://www.variadic.xyz/css/main.css" />
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
  
  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/styles/default.min.css">
  
  
  
  <meta property="og:title" content="Ubuntu 20.04 on MacBook Pro 2011" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="/2020/06/15/ubuntu-2011mbp//" />
  <meta property="og:image" content="" />
  
</head>


  <body>

    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://www.variadic.xyz/">a few notes</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
      
        
          <li>
          <a title="Notes" href="/">Notes</a>
  	      </li>
  	    
      
        
          <li>
          <a title="About" href="/about/">About</a>
  	      </li>
  	    
      
        
          <li>
          <a title="Archive" href="/archive/">Archive</a>
  	      </li>
  	    
      
        
          <li>
          <a title="Books" href="/books/">Books</a>
  	      </li>
  	    
      
        
          <li>
          <a title="Disclaimer" href="/disclaimer/">Disclaimer</a>
  	      </li>
  	    
      
      </ul>
    </div>

	<div class="avatar-container">
	  <div class="avatar-img-border">
      
	  </div>
	</div>

  </div>
</nav>


    <div role="main" class="container main-content">

      
        





<header class="header-section ">

<div class="intro-header no-img">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="post-heading">
          <h1>Ubuntu 20.04 on MacBook Pro 2011</h1>
      
      
      
      <span class="post-meta"> June 15, 2020 </span>
      
        </div>
      </div>
    </div>
  </div>
</div>
</header>





<div class="container">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
          

<p><a href="/2020/05/28/2011mbp-osx/">Previously</a>, i tried to use my MBP2011 functional, but seemed like linux could be a better fit as well. Thought of giving it a try (why not).</p>

<p>Ubuntu 20.04 just came out and installing it was just a breeze. I think there are ample or resources available that walk you thru how to create a bootable usb drive (efi based), so won&rsquo;t rehash here.</p>

<p><br/></p>

<h3 id="grub-customization">GRUB customization</h3>

<hr />

<p>Now, i did ensure that <code>nvram</code> had set up <code>gpu-power-prefs</code> correctly to always go with iGPU. Once installed now it was important to ensure that dGPU stayed off and did not kick in.</p>

<p>GRUB to rescue (more on GRUB later):</p>

<pre><code>sudo vim /etc/default/grub
</code></pre>

<p>update <code>GRUB_CMDLINE_LINUX_DEFAULT</code> with following options. Here we are asking kernel to neglect radeon driver, even if it is found &amp; go with i915 (intel iGPU) instead.</p>

<pre><code>GRUB_DEFAULT=0
GRUB_TIMEOUT_STYLE=hidden
GRUB_TIMEOUT=0
GRUB_DISTRIBUTOR=`lsb_release -i -s 2&gt; /dev/null || echo Debian`
GRUB_CMDLINE_LINUX_DEFAULT=&quot;quiet splash radeon.modeset=0 i915.lvds_channel_mode=2 i915.modeset=1&quot;
GRUB_CMDLINE_LINUX=&quot;&quot;
</code></pre>

<p>Now this will just switch GPU, but will not power off dGPU. To achieve that:</p>

<pre><code>sudo vim /etc/grub.d/10_linux
</code></pre>

<blockquote>
<p>more details here <a href="https://forums.macrumors.com/threads/installing-ubuntu-on-2011-mbp-with-failed-amd-gpu.2182103/">https://forums.macrumors.com/threads/installing-ubuntu-on-2011-mbp-with-failed-amd-gpu.2182103/</a></p>
</blockquote>

<p>It is important to add <code>outb</code> lines before <code>insmod gzio</code> (this is a grub thing). Basically GRUB will load (<code>insmod</code>) <code>gzio</code> before loading kernel (often linux kernel is compressed). Lines <code>6-9</code> are of interest here. After <code>GRUB_GFXPAYLOAD_LINUX</code> and before <code>insmod gzio</code>.</p>

<pre><code>if ([ &quot;$ubuntu_recovery&quot; = 0 ] || [ x$type != xrecovery ]) &amp;&amp; \
   ([ &quot;x$GRUB_GFXPAYLOAD_LINUX&quot; != x ] || [ &quot;$gfxpayload_dynamic&quot; = 1 ]); then
    echo &quot;    gfxmode \$linux_gfx_mode&quot; | sed &quot;s/^/$submenu_indentation/&quot;
fi

echo &quot;        outb 0x728 1&quot; | sed &quot;s/^/$submenu_indentation/&quot;
echo &quot;          outb 0x710 2&quot; | sed &quot;s/^/$submenu_indentation/&quot;
echo &quot;          outb 0x740 2&quot; | sed &quot;s/^/$submenu_indentation/&quot;
echo &quot;          outb 0x750 0&quot; | sed &quot;s/^/$submenu_indentation/&quot;
echo &quot;        insmod gzio&quot; | sed &quot;s/^/$submenu_indentation/&quot;
</code></pre>

<p>Once done with updating grub config and files, ensure that you update grub:</p>

<pre><code>sudo update grub
</code></pre>

<p>Now, the best part of this is dGPU is completely powered down. <a href="/2020/06/03/lmsensors-config/">Can be checked with <code>sensors</code> as installed with lm-sensors</a>. I can see that GPU-diode consistently reports either <code>-128</code> or low single digit numbers (as the heat sink is shared between both CPU &amp; dGPU). But overall MacBook is quite cool and does not heat up at all (to the point I don&rsquo;t even need a laptop cooler to use it :) ).</p>

<p>A note about previous magic numbers:</p>

<pre><code>outb 0x728 1 # Switch select
outb 0x710 2 # Switch display
outb 0x740 2 # Switch DDC
outb 0x750 0 # Power down discrete graphics
</code></pre>

<p>Now, on every reboot this sets up well &amp; looks very usable overall..</p>

<p><br/></p>

<h3 id="setting-up-ubuntu">Setting up Ubuntu</h3>

<hr />

<p>I tried both <code>KDE</code> and <code>Gnome</code>. I found <code>Gnome</code> to be quite handy as compared to <code>KDE</code>. Matter of personal choice- both desktop envs are great. I like the typography as well. Anyway following packages are easily installed and used.</p>

<pre><code>sudo apt install hwinfo
sudo apt install lm-sensors
sudo apt install htop
sudo apt install git
sudo apt install ksysguard
sudo apt install tmux
sudo apt install powertop
sudo apt install smartmontools
sudo apt install okular
sudo apt install vim
sudo apt install psensor
sudo apt install nodejs
sudo apt install npm
</code></pre>

<p>Goes without saying that I installed <code>VisualStudio Code</code> and <code>Brave/Chrome</code> browsers. But that is it really.</p>

<h2 id="br"><br/></h2>

<p>With all these setup, I found that <a href="/2020/06/08/disabling-turbo/">turning off turbo-boost</a> helped keep temperature in control. But the biggest benefit came by switching off dGPU (<code>outb</code> magic addresses).</p>

<p>With MacOS following things did not work, but they do now with Linux/Ubuntu:</p>

<ol>
<li>Screen Brightness buttons, work out of the box</li>
<li>Sleep, if I close the lid and reopen, computer wakes up and it is functional.</li>
<li>Updates/Upgrades, a few glitches but functional</li>
</ol>

<!--

//https://help.ubuntu.com/community/MacBookPro8-2/Raring

Booting from usb pen via EFI
To successfully boot via EFI we need to turn off the radeon card, since it won't be able to access the BIOS and will fail to load (error in dmesg: radeon 0000:01:00.0: Invalid ROM contents . To do this we need add some outb commands in GRUB and set some options:

Download the normal image and dd it onto your USB
During boot hold down the option key and select EFI boot ( USB Icon )
On GRUB edit the entry for ubuntu. Add the following after insmod ext2

//  https://github.com/blackgate/AMDGPUWakeHandler/blob/master/AMDGPUWakeHandler/AMDGPUWakeHandler.cpp
outb 0x728 1 # Switch select
outb 0x710 2 # Switch display
outb 0x740 2 # Switch DDC
outb 0x750 0 # Power down discrete graphics
Add after quiet splash -


    quiet splash i915.lvds_channel_mode=2 i915.modeset=1 i915.lvds_use_ssc=0
This will disable the radeon card and only use the integrated card. After the usb pen boots you should be able to install ubuntu. In order to then boot ubuntu from disk after installation you will need to change the GRUB entry on disk permanently to have the entries above. Probably the first time you boot you have to set make the changes in the GRUB by hand, and after you manage to login into ubuntu you can then make those changes permanent.


https://wiki.debian.org/InstallingDebianOn/Apple/MacBookPro/9-1
https://gist.github.com/cdleon/ae1542279598fe80f527400cc354a956
https://askubuntu.com/questions/92218/how-to-execute-a-command-after-resume-from-suspend
https://manpages.ubuntu.com/manpages/xenial/man8/pm-action.8.html


https://blog.christophersmart.com/2016/05/11/running-scripts-before-and-after-suspend-with-systemd/comment-page-1/
https://blog.christophersmart.com/2016/05/08/automatic-power-saving-on-a-linux-laptop-with-powertop-and-systemd/
https://stackoverflow.com/questions/42283324/waking-up-from-pm-suspend-results-in-full-restart


// boot with grub
https://www.linuxjournal.com/article/4622

// GRUB oreilly
https://www.oreilly.com/library/view/linux-in-a/0596004826/ch04s03.html

// GRUB manual
https://www.gnu.org/software/grub/manual/grub/grub.html#Introduction

-->

      </article>
      <br/>
      <ul class="pager blog-pager">
        
        <li class="previous">
          <a href="https://www.variadic.xyz/2020/06/08/disabling-turbo/" data-toggle="tooltip" data-placement="top" title="disabling turbo-bost">&larr; Previous</a>
        </li>
        
        
        <li class="next">
          <a href="https://www.variadic.xyz/2020/06/19/ssh-terminate-remote-processes/" data-toggle="tooltip" data-placement="top" title="ssh terminate &amp; remote process">Next &rarr;</a>
        </li>
        
      </ul>

      

    </div>
  </div>
</div>

      

    </div>

    <footer>
  <div class="container beautiful-jekyll-footer">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
          
          
          <li>
            <a href="https://github.com/sarangbaheti" title="GitHub">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
		      
		      
          <li>
            <a href="https://linkedin.com/in/sarangbaheti" title="LinkedIn">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
	    	  
          <li>
            <a href="https://stackoverflow.com/users/916549/sarang" title="StackOverflow">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-stack-overflow fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
    		  <li>
      			<a href="https://www.variadic.xyz/index.xml" title="RSS">
      			  <span class="fa-stack fa-lg">
        				<i class="fa fa-circle fa-stack-2x"></i>
        				<i class="fa fa-rss fa-stack-1x fa-inverse"></i>
      			  </span>
      			</a>
    		  </li>		

        </ul>
        <p class="copyright text-muted">
    		  Sarang Baheti
    		  &nbsp;&bull;&nbsp;
    		  2020
    		  
    		  
    		  &nbsp;&bull;&nbsp;
    		  <a href="https://www.variadic.xyz/">a few notes</a>
    		  
  	    </p>
  	        
    		<p class="theme-by text-muted">
    		  Theme by
    		  <a href="https://github.com/sarangbaheti/bh">bh</a>
    		</p>
      </div>
    </div>
  </div>
</footer>

<script src="https://www.variadic.xyz/js/jquery-1.11.2.min.js"></script>
<script src="https://www.variadic.xyz/js/bootstrap.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/highlight.min.js"></script>
<script src="https://www.variadic.xyz/js/main.js"></script>


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-27935503-1', 'auto');
ga('send', 'pageview');
</script>



  </body>
</html>
