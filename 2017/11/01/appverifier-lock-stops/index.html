<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>appverifier lock stops</title>

  <meta name="author" content="Sarang Baheti" />
  
  
  <meta name="description" content="Application Verifier Lock Stops Information">
  

  <meta name="generator" content="Hugo 0.30.2" />

  <link rel="alternate" href="https://www.variadic.xyz/index.xml" type="application/rss+xml" title="a few notes">

  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" />
  <link rel="stylesheet" href="https://www.variadic.xyz/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://www.variadic.xyz/css/main.css" />
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
  
  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/styles/default.min.css">
  
  
  
  <meta property="og:title" content="appverifier lock stops" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="/2017/11/01/appverifier-lock-stops/" />
  <meta property="og:image" content="" />
  
</head>


  <body>

    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://www.variadic.xyz/">a few notes</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
      
        
          <li>
          <a title="Notes" href="/">Notes</a>
  	      </li>
  	    
      
        
          <li>
          <a title="About" href="/about/">About</a>
  	      </li>
  	    
      
        
          <li>
          <a title="Archive" href="/archive/">Archive</a>
  	      </li>
  	    
      
        
          <li>
          <a title="Books" href="/books/">Books</a>
  	      </li>
  	    
      
        
          <li>
          <a title="Disclaimer" href="/disclaimer/">Disclaimer</a>
  	      </li>
  	    
      
      </ul>
    </div>

	<div class="avatar-container">
	  <div class="avatar-img-border">
      
	  </div>
	</div>

  </div>
</nav>


    <div role="main" class="container main-content">

      
        





<header class="header-section ">

<div class="intro-header no-img">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="post-heading">
          <h1>appverifier lock stops</h1>
      
      
      
      <span class="post-meta">Posted on November 1, 2017</span>
      
        </div>
      </div>
    </div>
  </div>
</div>
</header>




<div class="container">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
          

<p>Reference: <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/dd371695(v=vs.85).aspx">AppVerifier Locks</a>
<br/>
This is more of a dump from various pages of MSDN for handy reference.</p>


<figure >
    
        <img src="/images/appverifier-locks.png" />
    
    
</figure>


<p>A few links i have found useful over time are:</p>

<ul>
<li><a href="https://blogs.msdn.microsoft.com/meason/2010/03/25/application-verifier-for-locks-usage/">application-verifier-for-locks-usage</a></li>
<li><a href="https://blogs.technet.microsoft.com/yongrhee/2013/10/17/how-to-debug-critical-section-issues-using-appverifier/">how-to-debug-critical-section-issues-using-appverifier</a></li>
</ul>

<hr />

<h3 id="200"><code>200:</code></h3>

<p>This stop is generated if a thread (thread ID is parameter1) is terminated, suspended or is in a state  worker thread finished a work item) in which it cannot hold a critical section. The current thread is the culprit. To debug this stop use the following debugger commands:</p>

<ul>
<li><code>$ kb</code> - to get the current stack trace. If the current thread is the owner of the critical section it is probably calling <code>ExitThread</code>. The current thread should have released the critical section before exiting. If the current thread is calling <code>TerminateThread</code> or <code>SuspendThread</code> then it should not do this for a thread holding a critical section.</li>
<li><code>$ !cs -s parameter2</code> - dump information about this critical section.</li>
<li><code>$ ln parameter2</code> - to show symbols near the address of the critical section. This should help identify the leaked critical section.</li>
<li><code>$ dps parameter4</code> - to dump the stack trace for this critical section initialization.</li>
</ul>

<hr />

<h3 id="201"><code>201:</code></h3>

<p>This stop is generated if a DLL has a global variable containing a critical section and the DLL is unloaded but the critical section has not been deleted. To debug this stop use the following debugger commands:</p>

<ul>
<li><code>$ du parameter3</code> - to dump the name of the culprit DLL.</li>
<li><code>$ .reload dllname</code> or <code>.reload dllname = parameter4</code> - to reload the symbols for that DLL.</li>
<li><code>$ !cs -s parameter1</code> - dump information about this critical section.</li>
<li><code>$ ln parameter1</code> - to show symbols near the address of the critical section. This should help identify the leaked critical section.</li>
<li><code>$ dps parameter2</code> - to dump the stack trace for this critical section initialization.</li>
</ul>

<hr />

<h3 id="202"><code>202:</code></h3>

<p>This stop is generated if a heap allocation contains a critical section, the allocation is freed and the critical section has not been deleted. To debug this stop use the following debugger commands:</p>

<ul>
<li><code>$ !cs -s parameter1</code> - dump information about this critical section.</li>
<li><code>$ ln parameter1</code> - to show symbols near the address of the critical section. This should help identify the leaked critical section.</li>
<li><code>$ dps parameter2</code> - to dump the stack trace for this critical section initialization.</li>
<li><code>$ parameter3</code> and parameter4 might help understand where this heap block was allocated (the size of the allocation is probably significant).</li>
</ul>

<hr />

<h3 id="203"><code>203:</code></h3>

<p>Usually this stop is generated if a critical section has been initialized more than one time. In this case <code>parameter3</code> and <code>parameter4</code> are the stack trace addresses for two of these initializations. Some other times it is possible to get this stop if the critical section or its debug information structure has been corrupted. In this second case it is possible that parameter3 and parameter4 are invalid and useless. To debug this stop:</p>

<ul>
<li><code>$ !cs -s -d parameter2</code> - dump information about this critical section.</li>
<li><code>$ ln parameter1</code> - to show symbols near the address of the critical section. This might help identify the critical section if this is a global variable.</li>
<li><code>$ dps parameter3</code> and <code>dps parameter4</code> - to identify the two code paths for initializing this critical section.</li>
</ul>

<hr />

<h3 id="204"><code>204:</code></h3>

<p>This stop is generated if the memory containing a critical section was freed but the critical section has not been deleted using <code>DeleteCriticalSection</code>. To debug this stop use the following debugger commands:</p>

<ul>
<li><code>$ !cs -s -d parameter2</code> - dump information about this critical section.</li>
<li><code>$ dps parameter3</code> - to identify the code path for initializing this critical section.</li>
</ul>

<p>In most cases the lock verifier detects immediately leaked critical sections contained in a heap allocation, a DLL range, a virtual memory allocation or a <code>MapViewOfFile</code> mapped memory range and issues different stops in these cases. So there are very few cases left for this verifier stop. The lock must be in a memory range freed by kernel-mode code or freed cross-process by APIs like <code>VirtualFreeEx</code>. Most typically this stop will  be encountered if a previous stop (e.g. <code>LOCK_IN_FREED_HEAP</code> or  <code>LOCK_IN_UNLOADED_DLL</code>) was continued by hitting <code>g</code> in the debugger console.</p>

<hr />

<h3 id="205"><code>205:</code></h3>

<p>This stop is generated if the DebugInfo field of the critical section is pointing freed memory. Usually another valid DebugInfo structure is found in the active critical section list. Without corruption the two pointers should be identical. To debug this stop use the following debugger commands:</p>

<ul>
<li><code>$ !cs -s -d parameter3</code> - dump information about this critical section based on the current contents of the debug info structure found in the active list (this structure is rarely corrupted so usually this information is trustworthy).</li>
<li><code>$ !cs -s parameter1</code> - dump information about this critical section based on the current contents of the critical section structure (the structure is corrupted already so sometimes this information is NOT trustworthy).</li>
<li><code>$ dps parameter4</code> - to identify the code path for initializing this critical section.</li>
</ul>

<p>Dump the critical section at address parameter1 and look for the corruption pattern. With good symbols for ntdll.dl you can use the following commands:</p>

<ul>
<li><code>$ dt ntdll!_RTL_CRITICAL_SECTION LOCK_ADDRESS</code></li>
<li><code>$ dt ntdll!_RTL_CRITICAL_SECTION_DEBUG DEBUG_ADDRESS</code></li>
</ul>

<hr />

<h3 id="206"><code>206:</code></h3>

<p>This stop is generated if the owner thread ID is invalid in the current context. For example, the critical section is being released by a thread  other than the one that acquired it. To debug this stop:</p>

<ul>
<li><code>$ !cs -s parameter1</code> - dump information about this critical section.</li>
<li><code>$ ln parameter1</code> - to show symbols near the address of the critical section. This should help identify the critical section.</li>
</ul>

<hr />

<h3 id="207"><code>207:</code></h3>

<p>This stop is generated if the recursion count field of the critical section structure is invalid in the current context. To debug this stop:</p>

<ul>
<li><code>$ !cs -s parameter1</code> - dump information about this critical section.</li>
<li><code>$ ln parameter1</code> - to show symbols near the address of the critical section. This should help identify the critical section.</li>
</ul>

<hr />

<h3 id="208"><code>208:</code></h3>

<p>This stop is generated if a critical section is owned by a thread if it is deleted or if the critical section is uninitialized. To debug this stop:</p>

<ul>
<li><code>$ !cs -s parameter1</code> - dump information about this critical section. If the owning thread is 0 the critical section has not been initialized.</li>
<li><code>$ ln parameter1</code> - to show symbols near the address of the critical section. This should help identify the critical section.</li>
</ul>

<hr />

<h3 id="209"><code>209:</code></h3>

<p>This stop is generated if a critical section is released more times than the current thread acquired it. To debug this stop:</p>

<ul>
<li><code>$ !cs -s parameter1</code> - dump information about this critical section.</li>
<li><code>$ !cs -s -d parameter4</code> - dump information about this critical section.</li>
<li><code>$ ln parameter1</code> - to show symbols near the address of the critical section. This should help identify the critical section.</li>
</ul>

<hr />

<h3 id="210"><code>210:</code></h3>

<p>This stop is generated if a critical section is used without being initialized or after it has been deleted. To debug this stop:</p>

<ul>
<li><code>$ ln parameter1</code> - to show symbols near the address of the critical section. This should help identify the critical section.</li>
</ul>

<hr />

<h3 id="211"><code>211:</code></h3>

<p>This stop is generated if a critical section is reinitialized by the current thread. To debug this stop:</p>

<ul>
<li><code>$ !cs -s parameter1</code> or <code>!cs -s -d parameter2</code> - dump information about this critical section.</li>
<li><code>$ ln parameter1</code> - to show symbols near the address of the critical section.</li>
</ul>

<p>This might help identify the critical section if this is a global variable.</p>

<hr />

<h3 id="212"><code>212:</code></h3>

<p>This stop is generated if the current thread is calling <code>VirtualFree</code> on a memory block that contains an active critical section. The application should call <code>DeleteCriticalSection</code> on this critical section before if frees this memory.</p>

<ul>
<li><code>$ kb</code> - to display the current stack trace, that is calling VirtualFree. The probable culprit is the DLL that calls VirtualFree.</li>
<li><code>$ !cs -s parameter1</code> - dump information about this critical section.</li>
<li><code>$ dps parameter2</code> - to identify the code path for the initialization of this critical section.</li>
</ul>

<hr />

<h3 id="213"><code>213:</code></h3>

<p>This stop is generated if the current thread is calling <code>UnmapViewOfFile</code> on a memory block that contains an active critical section. The application should call <code>DeleteCriticalSection</code> on this critical section before if unmaps this memory.</p>

<ul>
<li><code>$ kb</code> - to display the current stack trace, that is calling <code>UnmapViewOfFile</code> . The probable culprit is the DLL that calls <code>UnmapViewOfFile</code>.</li>
<li><code>$ !cs -s parameter1</code> - dump information about this critical section.</li>
<li><code>$ dps parameter2</code> - to identify the code path for the initialization of this critical section.</li>
</ul>

<hr />

<h3 id="214"><code>214:</code></h3>

<p>This stop is generated if the current thread is calling <code>LeaveCriticalSection</code> but, according to the internal verifier bookkeeping, it doesn&rsquo;t own any critical section.</p>

<p>If <code>parameter2</code> is zero, probably this is a bug in the current thread.
It either tries to leave a critical section that it didn&rsquo;t enter, or maybe it is calling <code>LeaveCriticalSection</code> more times than it called <code>EnterCriticalSection</code> for the same critical section.</p>

<hr />

<h3 id="215"><code>215:</code></h3>

<p>This stop is generated if the current thread tries to use a private lock that livesinside another DLL. For example a.dll tries to enter a critical section defined inside ntdll.dll. Private locks cannot be used across DLLs.</p>

      </article>

      <ul class="pager blog-pager">
        
        <li class="previous">
          <a href="https://www.variadic.xyz/2017/10/31/library-loading-issues-windows/" data-toggle="tooltip" data-placement="top" title="debugging library load issues on windows">&larr; Previous Post</a>
        </li>
        
        
        <li class="next">
          <a href="https://www.variadic.xyz/2017/11/06/error-handling-links/" data-toggle="tooltip" data-placement="top" title="Error Handling Links">Next Post &rarr;</a>
        </li>
        
      </ul>

      

    </div>
  </div>
</div>

      

    </div>

    <footer>
  <div class="container beautiful-jekyll-footer">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
          
          
          <li>
            <a href="https://github.com/sarangbaheti" title="GitHub">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
		      
		      
          <li>
            <a href="https://linkedin.com/in/sarangbaheti" title="LinkedIn">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
	    	  
          <li>
            <a href="https://stackoverflow.com/users/916549/sarang" title="StackOverflow">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-stack-overflow fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
    		  <li>
      			<a href="https://www.variadic.xyz/index.xml" title="RSS">
      			  <span class="fa-stack fa-lg">
        				<i class="fa fa-circle fa-stack-2x"></i>
        				<i class="fa fa-rss fa-stack-1x fa-inverse"></i>
      			  </span>
      			</a>
    		  </li>		

        </ul>
        <p class="copyright text-muted">
    		  Sarang Baheti
    		  &nbsp;&bull;&nbsp;
    		  2009 - 2020
    		  
    		  
    		  &nbsp;&bull;&nbsp;
    		  <a href="https://www.variadic.xyz/">a few notes</a>
    		  
  	    </p>
  	        
    		<p class="theme-by text-muted">
    		  Theme by
    		  <a href="https://github.com/sarangbaheti/bh">bh</a>
    		</p>
      </div>
    </div>
  </div>
</footer>

<script src="https://www.variadic.xyz/js/jquery-1.11.2.min.js"></script>
<script src="https://www.variadic.xyz/js/bootstrap.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/highlight.min.js"></script>
<script src="https://www.variadic.xyz/js/main.js"></script>


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-27935503-1', 'auto');
ga('send', 'pageview');
</script>



  </body>
</html>
