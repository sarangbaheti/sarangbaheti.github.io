<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
  <head>
    

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>C&#43;&#43;11 thread safe statics - a few notes</title>
  <meta name="description" content="how c&#43;&#43;11 threadsafe statics are implemented under the hood">
  <meta name="author" content="Sarang Baheti"/><script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "WebSite",
    "name": "a few notes",
    
    "url": "https:\/\/www.variadic.xyz\/"
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "",
  "url": "https:\/\/www.variadic.xyz\/"
  
  
  
  
}
</script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
        "@type": "ListItem",
        "position": 1,
        "item": {
          "@id": "https:\/\/www.variadic.xyz\/",
          "name": "home"
        }
    },{
        "@type": "ListItem",
        "position": 3,
        "item": {
          "@id": "https:\/\/www.variadic.xyz\/2017\/06\/20\/cpp11-threadsafe-statics\/",
          "name": "C\u002b\u002b11 thread safe statics"
        }
    }]
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "author": {
    "name" : "Sarang Baheti"
  },
  "headline": "C\u002b\u002b11 thread safe statics",
  "description" : "how c\u002b\u002b11 threadsafe statics are implemented under the hood",
  "inLanguage" : "en",
  "wordCount":  472 ,
  "datePublished" : "2017-06-20T10:54:24",
  "dateModified" : "2017-06-20T10:54:24",
  "image" : "https:\/\/www.variadic.xyz\/",
  "keywords" : [ "" ],
  "mainEntityOfPage" : "https:\/\/www.variadic.xyz\/2017\/06\/20\/cpp11-threadsafe-statics\/",
  "publisher" : {
    "@type": "Organization",
    "name" : "https:\/\/www.variadic.xyz\/",
    "logo" : {
        "@type" : "ImageObject",
        "url" : "https:\/\/www.variadic.xyz\/",
        "height" :  60 ,
        "width" :  60
    }
  }
}
</script>

<meta property="og:title" content="C&#43;&#43;11 thread safe statics" />
<meta property="og:description" content="how c&#43;&#43;11 threadsafe statics are implemented under the hood">
<meta property="og:url" content="https://www.variadic.xyz/2017/06/20/cpp11-threadsafe-statics/" />
<meta property="og:type" content="website" />
<meta property="og:site_name" content="a few notes" />

  <meta name="twitter:title" content="C&#43;&#43;11 thread safe statics" />
  <meta name="twitter:description" content="how c&#43;&#43;11 threadsafe statics are implemented under the hood">
  <meta name="twitter:card" content="summary" />
  <meta name="generator" content="Hugo 0.73.0" />
  <link rel="alternate" href="https://www.variadic.xyz/index.xml" type="application/rss+xml" title="a few notes"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css" integrity="sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous"><link rel="stylesheet" href="https://www.variadic.xyz/css/main.css" /><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" /><link rel="stylesheet" href="https://www.variadic.xyz/css/syntax.css" /><link rel="stylesheet" href="https://www.variadic.xyz/css/codeblock.css" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css" integrity="sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css" integrity="sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R" crossorigin="anonymous">


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-27935503-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://www.variadic.xyz/">a few notes</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="Notes" href="/">Notes</a>
            </li>
          
        
          
            <li>
              <a title="About" href="/about/">About</a>
            </li>
          
        
          
            <li>
              <a title="Archive" href="/archive/">Archive</a>
            </li>
          
        
          
            <li>
              <a title="Books" href="/books/">Books</a>
            </li>
          
        
          
            <li>
              <a title="Disclaimer" href="/disclaimer/">Disclaimer</a>
            </li>
          
        

        

        
      </ul>
    </div>

    

  </div>
</nav>




    


<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>


  
  
  






  

  <header class="header-section ">
    
    <div class="intro-header no-img">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="post-heading">
              
                <h1>C&#43;&#43;11 thread safe statics</h1>
              
              
              
              
                <span class="post-meta">
  
  

  
    Posted on June 20, 2017
  

  
  
  
  
  
</span>


              
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>


    
<div class="container" role="main">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">

      
      

        
          
          <p>My good colleage, Mike.McCarty, put out code for review and stated that statics are thread-safe. As it is, sounded very scary but I trust Mike. Thus started exploring what has been done there.</p>

<blockquote>
<p>here is the std document for the same: <a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2008/n2660.htm">http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2008/n2660.htm</a></p>
</blockquote>

<p>First thing wrote some code to dump disassembly in VS2015:</p>
<pre><code>static int function()
{
00007FF7610C1910  push        rbp 
00007FF7610C1912  push        rdi 
00007FF7610C1913  sub         rsp,108h 
00007FF7610C191A  lea         rbp,[rsp+20h] 
00007FF7610C191F  mov         rdi,rsp 
00007FF7610C1922  mov         ecx,42h 
00007FF7610C1927  mov         eax,0CCCCCCCCh 
00007FF7610C192C  rep stos    dword ptr [rdi] 
00007FF7610C192E  mov         qword ptr [rbp+0C8h],0FFFFFFFFFFFFFFFEh 
    static int s_value = function2();
00007FF7610C1939  mov         eax,104h 
00007FF7610C193E  mov         eax,eax 
00007FF7610C1940  mov         ecx,dword ptr [_tls_index (07FF7610CC1C8h)] 
00007FF7610C1946  mov         rdx,qword ptr gs:[58h] 
00007FF7610C194F  mov         rcx,qword ptr [rdx+rcx*8] 
00007FF7610C1953  mov         eax,dword ptr [rax+rcx] 
00007FF7610C1956  cmp         dword ptr [s_value+4h (07FF7610CC164h)],eax 
00007FF7610C195C  jle         function+7Ah (07FF7610C198Ah) 
00007FF7610C195E  lea         rcx,[s_value+4h (07FF7610CC164h)] 
00007FF7610C1965  call        _Init_thread_header (07FF7610C101Eh) 
00007FF7610C196A  cmp         dword ptr [s_value+4h (07FF7610CC164h)],0FFFFFFFFh 
00007FF7610C1971  jne         function+7Ah (07FF7610C198Ah) 
00007FF7610C1973  call        function2 (07FF7610C18D0h) 
00007FF7610C1978  mov         dword ptr [s_value (07FF7610CC160h)],eax 
00007FF7610C197E  lea         rcx,[s_value+4h (07FF7610CC164h)] 
00007FF7610C1985  call        _Init_thread_footer (07FF7610C1073h) 
    return s_value;
00007FF7610C198A  mov         eax,dword ptr [s_value (07FF7610CC160h)] 
}</code></pre>
<p>Now with this Mike asked is why is TLS even involved?</p>
<pre><code>00007FF7610C1939  mov         eax,104h 
00007FF7610C193E  mov         eax,eax 
00007FF7610C1940  mov         ecx,dword ptr [_tls_index (07FF7610CC1C8h)] 
00007FF7610C1946  mov         rdx,qword ptr gs:[58h] 
00007FF7610C194F  mov         rcx,qword ptr [rdx+rcx*8] 
00007FF7610C1953  mov         eax,dword ptr [rax+rcx] </code></pre>
<p>Well my guess is that it is trying to reduce contention among threads initializing same static variable.
If you call the static function twice it will still go thru the this code as it does not know whether it is the first call or not.</p>
<pre><code>    static int s_value = function2();
00007FF7610C1939  mov         eax,104h 
00007FF7610C193E  mov         eax,eax 
00007FF7610C1940  mov         ecx,dword ptr [_tls_index (07FF7610CC1C8h)] 
00007FF7610C1946  mov         rdx,qword ptr gs:[58h] 
00007FF7610C194F  mov         rcx,qword ptr [rdx+rcx*8] 
00007FF7610C1953  mov         eax,dword ptr [rax+rcx] 
00007FF7610C1956  cmp         dword ptr [s_value+4h (07FF7610CC164h)],eax 
00007FF7610C195C  jle         function+7Ah (07FF7610C198Ah) </code></pre>
<p>In case of multiple threads calling the same function- there is a possibility of contention.
This is where TLS helps (DCLP I guess)</p>

<blockquote>
<p>Two records are maintained &amp; updated:</p>

<ol>
<li>Thread local to reduce contention &amp; DCLP</li>
<li>Global: s_value2 + 4h</li>
</ol>
</blockquote>

<p>Same can be seen, done a bit differently on linux (<a href="https://godbolt.org/g/GfKMQc):">https://godbolt.org/g/GfKMQc):</a></p>
<pre><code>function2():                         # @function2()
        push    rbp
        mov     rbp, rsp
        sub     rsp, 16
        cmp     byte ptr [guard variable for function2()::val], 0
        jne     .LBB1_4
        movabs  rdi, guard variable for function2()::val
        call    __cxa_guard_acquire
        cmp     eax, 0
        je      .LBB1_4
        call    function()
        mov     dword ptr [rbp - 16], eax # 4-byte Spill
        jmp     .LBB1_3
.LBB1_3:
        movabs  rdi, guard variable for function2()::val
        mov     eax, dword ptr [rbp - 16] # 4-byte Reload
        mov     dword ptr [function2()::val], eax
        call    __cxa_guard_release
.LBB1_4:
        add     rsp, 16
        pop     rbp
        ret
        movabs  rdi, guard variable for function2()::val
        mov     ecx, edx
        mov     qword ptr [rbp - 8], rax
        mov     dword ptr [rbp - 12], ecx
        call    __cxa_guard_abort
        mov     rdi, qword ptr [rbp - 8]
        call    _Unwind_Resume</code></pre>
<p>Here <code>__cxa_guard_acquire</code>, <code>__cxa_guard_release</code> and <code>__cxa_guard_abort</code> do the magic.</p>

        
      
      <br/>
      
        
        

        <hr>
        
      </article>

      
        <ul class="pager blog-pager">
          
            <li class="previous">
              <a href="https://www.variadic.xyz/2017/03/04/github-multiple-accounts-setup-notes/" data-toggle="tooltip" data-placement="top" title="github multiple accounts setup notes">&larr; Previous Post</a>
            </li>
          
          
            <li class="next">
              <a href="https://www.variadic.xyz/2017/07/04/patch/" data-toggle="tooltip" data-placement="top" title="patch">Next Post &rarr;</a>
            </li>
          
        </ul>
      


      

    </div>
  </div>
</div>

      
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
          
        </ul>
        <p class="credits copyright text-muted">
          
            
              Sarang Baheti
            
          

          &nbsp;&bull;&nbsp;&copy;
          
            2020
          

          
            &nbsp;&bull;&nbsp;
            <a href="https://www.variadic.xyz/">a few notes</a>
          
        </p>
        
        <p class="credits theme-by text-muted">
          <a href="https://gohugo.io">Hugo v0.73.0</a> powered &nbsp;&bull;&nbsp; Theme <a href="https://github.com/sarangbaheti/beautifulhugo">beautifulhugo</a> forked from <a href="https://github.com/halogenica/beautifulhugo"> halogenica/Beautiful Hugo</a>
          
        </p>
      </div>
    </div>
  </div>
</footer><script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.js" integrity="sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/contrib/auto-render.min.js" integrity="sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<script src="https://www.variadic.xyz/js/main.js"></script><script> renderMathInElement(document.body); </script><script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js" integrity="sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js" integrity="sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q" crossorigin="anonymous"></script><script src="https://www.variadic.xyz/js/load-photoswipe.js"></script>









    
  </body>
</html>

