<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>C&#43;&#43;11 thread safe statics</title>

  <meta name="author" content="Sarang Baheti" />
  
  
  <meta name="description" content="how c&#43;&#43;11 threadsafe statics are implemented under the hood">
  

  <meta name="generator" content="Hugo 0.30.2" />

  <link rel="alternate" href="https://www.variadic.xyz/index.xml" type="application/rss+xml" title="a few notes">

  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" />
  <link rel="stylesheet" href="https://www.variadic.xyz/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://www.variadic.xyz/css/main.css" />
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
  
  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/styles/default.min.css">
  
  
  
  <meta property="og:title" content="C&#43;&#43;11 thread safe statics" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="/2017/06/20/cpp11-threadsafe-statics//" />
  <meta property="og:image" content="" />
  
</head>


  <body>

    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://www.variadic.xyz/">a few notes</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
      
        
          <li>
          <a title="Notes" href="/">Notes</a>
  	      </li>
  	    
      
        
          <li>
          <a title="About" href="/about/">About</a>
  	      </li>
  	    
      
        
          <li>
          <a title="Archive" href="/archive/">Archive</a>
  	      </li>
  	    
      
        
          <li>
          <a title="Books" href="/books/">Books</a>
  	      </li>
  	    
      
        
          <li>
          <a title="Disclaimer" href="/disclaimer/">Disclaimer</a>
  	      </li>
  	    
      
      </ul>
    </div>

	<div class="avatar-container">
	  <div class="avatar-img-border">
      
	  </div>
	</div>

  </div>
</nav>


    <div role="main" class="container main-content">

      
        





<header class="header-section ">

<div class="intro-header no-img">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="post-heading">
          <h1>C&#43;&#43;11 thread safe statics</h1>
      
      
      
      <span class="post-meta"> June 20, 2017 </span>
      
        </div>
      </div>
    </div>
  </div>
</div>
</header>





<div class="container">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
          <p>My good colleage, Mike.McCarty, put out code for review and stated that statics are thread-safe. As it is, sounded very scary but I trust Mike. Thus started exploring what has been done there.</p>

<blockquote>
<p>here is the std document for the same: <a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2008/n2660.htm">http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2008/n2660.htm</a></p>
</blockquote>

<p>First thing wrote some code to dump disassembly in VS2015:</p>

<p></p>

<pre><code>static int function()
{
00007FF7610C1910  push        rbp 
00007FF7610C1912  push        rdi 
00007FF7610C1913  sub         rsp,108h 
00007FF7610C191A  lea         rbp,[rsp+20h] 
00007FF7610C191F  mov         rdi,rsp 
00007FF7610C1922  mov         ecx,42h 
00007FF7610C1927  mov         eax,0CCCCCCCCh 
00007FF7610C192C  rep stos    dword ptr [rdi] 
00007FF7610C192E  mov         qword ptr [rbp+0C8h],0FFFFFFFFFFFFFFFEh 
    static int s_value = function2();
00007FF7610C1939  mov         eax,104h 
00007FF7610C193E  mov         eax,eax 
00007FF7610C1940  mov         ecx,dword ptr [_tls_index (07FF7610CC1C8h)] 
00007FF7610C1946  mov         rdx,qword ptr gs:[58h] 
00007FF7610C194F  mov         rcx,qword ptr [rdx+rcx*8] 
00007FF7610C1953  mov         eax,dword ptr [rax+rcx] 
00007FF7610C1956  cmp         dword ptr [s_value+4h (07FF7610CC164h)],eax 
00007FF7610C195C  jle         function+7Ah (07FF7610C198Ah) 
00007FF7610C195E  lea         rcx,[s_value+4h (07FF7610CC164h)] 
00007FF7610C1965  call        _Init_thread_header (07FF7610C101Eh) 
00007FF7610C196A  cmp         dword ptr [s_value+4h (07FF7610CC164h)],0FFFFFFFFh 
00007FF7610C1971  jne         function+7Ah (07FF7610C198Ah) 
00007FF7610C1973  call        function2 (07FF7610C18D0h) 
00007FF7610C1978  mov         dword ptr [s_value (07FF7610CC160h)],eax 
00007FF7610C197E  lea         rcx,[s_value+4h (07FF7610CC164h)] 
00007FF7610C1985  call        _Init_thread_footer (07FF7610C1073h) 
    return s_value;
00007FF7610C198A  mov         eax,dword ptr [s_value (07FF7610CC160h)] 
}
</code></pre>

<p>Now with this Mike asked is why is TLS even involved?</p>

<pre><code>00007FF7610C1939  mov         eax,104h 
00007FF7610C193E  mov         eax,eax 
00007FF7610C1940  mov         ecx,dword ptr [_tls_index (07FF7610CC1C8h)] 
00007FF7610C1946  mov         rdx,qword ptr gs:[58h] 
00007FF7610C194F  mov         rcx,qword ptr [rdx+rcx*8] 
00007FF7610C1953  mov         eax,dword ptr [rax+rcx] 
</code></pre>

<p>Well my guess is that it is trying to reduce contention among threads initializing same static variable.
If you call the static function twice it will still go thru the this code as it does not know whether it is the first call or not.</p>

<pre><code>    static int s_value = function2();
00007FF7610C1939  mov         eax,104h 
00007FF7610C193E  mov         eax,eax 
00007FF7610C1940  mov         ecx,dword ptr [_tls_index (07FF7610CC1C8h)] 
00007FF7610C1946  mov         rdx,qword ptr gs:[58h] 
00007FF7610C194F  mov         rcx,qword ptr [rdx+rcx*8] 
00007FF7610C1953  mov         eax,dword ptr [rax+rcx] 
00007FF7610C1956  cmp         dword ptr [s_value+4h (07FF7610CC164h)],eax 
00007FF7610C195C  jle         function+7Ah (07FF7610C198Ah) 
</code></pre>

<p>In case of multiple threads calling the same function- there is a possibility of contention.
This is where TLS helps (DCLP I guess)</p>

<blockquote>
<p>Two records are maintained &amp; updated:</p>

<ol>
<li>Thread local to reduce contention &amp; DCLP</li>
<li>Global: s_value2 + 4h</li>
</ol>
</blockquote>

<p>Same can be seen, done a bit differently on linux (<a href="https://godbolt.org/g/GfKMQc):">https://godbolt.org/g/GfKMQc):</a></p>

<pre><code>function2():                         # @function2()
        push    rbp
        mov     rbp, rsp
        sub     rsp, 16
        cmp     byte ptr [guard variable for function2()::val], 0
        jne     .LBB1_4
        movabs  rdi, guard variable for function2()::val
        call    __cxa_guard_acquire
        cmp     eax, 0
        je      .LBB1_4
        call    function()
        mov     dword ptr [rbp - 16], eax # 4-byte Spill
        jmp     .LBB1_3
.LBB1_3:
        movabs  rdi, guard variable for function2()::val
        mov     eax, dword ptr [rbp - 16] # 4-byte Reload
        mov     dword ptr [function2()::val], eax
        call    __cxa_guard_release
.LBB1_4:
        add     rsp, 16
        pop     rbp
        ret
        movabs  rdi, guard variable for function2()::val
        mov     ecx, edx
        mov     qword ptr [rbp - 8], rax
        mov     dword ptr [rbp - 12], ecx
        call    __cxa_guard_abort
        mov     rdi, qword ptr [rbp - 8]
        call    _Unwind_Resume
</code></pre>

<p>Here <code>__cxa_guard_acquire</code>, <code>__cxa_guard_release</code> and <code>__cxa_guard_abort</code> do the magic.</p>
      </article>
      <br/>
      <ul class="pager blog-pager">
        
        <li class="previous">
          <a href="https://www.variadic.xyz/2017/03/04/github-multiple-accounts-setup-notes/" data-toggle="tooltip" data-placement="top" title="github multiple accounts setup notes">&larr; Previous</a>
        </li>
        
        
        <li class="next">
          <a href="https://www.variadic.xyz/2017/07/04/patch/" data-toggle="tooltip" data-placement="top" title="patch">Next &rarr;</a>
        </li>
        
      </ul>

      

    </div>
  </div>
</div>

      

    </div>

    <footer>
  <div class="container beautiful-jekyll-footer">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
          
          
          <li>
            <a href="https://github.com/sarangbaheti" title="GitHub">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
		      
		      
          <li>
            <a href="https://linkedin.com/in/sarangbaheti" title="LinkedIn">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
	    	  
          <li>
            <a href="https://stackoverflow.com/users/916549/sarang" title="StackOverflow">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-stack-overflow fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
    		  <li>
      			<a href="https://www.variadic.xyz/index.xml" title="RSS">
      			  <span class="fa-stack fa-lg">
        				<i class="fa fa-circle fa-stack-2x"></i>
        				<i class="fa fa-rss fa-stack-1x fa-inverse"></i>
      			  </span>
      			</a>
    		  </li>		

        </ul>
        <p class="copyright text-muted">
    		  Sarang Baheti
    		  &nbsp;&bull;&nbsp;
    		  2020
    		  
    		  
    		  &nbsp;&bull;&nbsp;
    		  <a href="https://www.variadic.xyz/">a few notes</a>
    		  
  	    </p>
  	        
    		<p class="theme-by text-muted">
    		  Theme by
    		  <a href="https://github.com/sarangbaheti/bh">bh</a>
    		</p>
      </div>
    </div>
  </div>
</footer>

<script src="https://www.variadic.xyz/js/jquery-1.11.2.min.js"></script>
<script src="https://www.variadic.xyz/js/bootstrap.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/highlight.min.js"></script>
<script src="https://www.variadic.xyz/js/main.js"></script>


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-27935503-1', 'auto');
ga('send', 'pageview');
</script>



  </body>
</html>
